using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.AI;

public class AvatarController : MonoBehaviour {
    public static event Action OnAvatarReached;
    private bool canContinue = false;

    [SerializeField] private CameraRecorder cameraRecorder;

    private Transform avatarTransform;
    private Vector3 startPosition;
    private static Vector3 targetPosition;

    [SerializeField] private NavMeshAgent navMeshAgent;

    [SerializeField] private Animator animator;

    private void Start() {
        avatarTransform = transform;

        startPosition = avatarTransform.position;
        targetPosition = avatarTransform.position;

        SetCameraToNearestNavMeshPosition();
    }

    private void SetCameraToNearestNavMeshPosition() {
        NavMeshHit hit;
        if (NavMesh.SamplePosition(avatarTransform.position, out hit, 20f, NavMesh.AllAreas)) {
            avatarTransform.position = hit.position;
            navMeshAgent.SetDestination(hit.position);
        } else {
            Debug.LogWarning("Could not find a valid NavMesh position for the camera starting point.");
        }
    }


    private void OnEnable() {
        CameraController.OnTourIDsReceived += HandleTourIDs;
        CameraController.OnCameraReached += HandleCameraReached;
    }

    private void OnDisable() {
        CameraController.OnTourIDsReceived -= HandleTourIDs;
        CameraController.OnCameraReached -= HandleCameraReached;
    }

    /* private void Update() {
        Vector3 currentPosition = transform.position;
        transform.position = new Vector3(currentPosition.x, 4.5f, currentPosition.z);
    } */

    private void HandleCameraReached() {
        canContinue = true;
    }

    private void HandleTourIDs(string[] tourIDs) {
        Debug.Log("Avatar Start Navigation");
        StartCoroutine(NavigationTour(tourIDs));
    }

    private float waitTime = 1f;
    // private float rotationSpeed = 1f;

    private IEnumerator NavigationTour(string[] tourIDs) {
        for (int i = 0; i < tourIDs.Length; i++) {
            // update Avatar target positions and orientations
            UpdateTargetAvatar(tourIDs[i]);
            Debug.Log("Avatar" + tourIDs[i]);
            animator.SetBool("Walk", true);
            navMeshAgent.SetDestination(targetPosition);

            // Wait until the camera reaches the painting
            while (navMeshAgent.pathPending || navMeshAgent.remainingDistance > navMeshAgent.stoppingDistance) {
                yield return null;
            }
            animator.SetBool("Walk", false);

            OnAvatarReached?.Invoke();
            yield return new WaitUntil(() => canContinue);
            canContinue = false;

            // Wait at the current position
            yield return new WaitForSeconds(waitTime);
        }
    }

    private void UpdateTargetAvatar(string tourID) {
        string cameraID = tourID.Replace("painting ", "Avatar.");

        targetPosition = cameraRecorder.GetCameraPosition(cameraID);
        // targetRotation = cameraRecorder.GetCameraOrientation(cameraID);
    }

}
